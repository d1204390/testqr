<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>智慧型發票掃描器</title>
    <script src="https://static.line-scdn.net/liff/edge/versions/2.15.0/sdk.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 16px;
            background: #f5f5f5;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .notice {
            background: #FFF9C4;
            color: #000;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
        }
        #reader {
            width: 100%;
            margin: 16px 0;
        }
        .button-container {
            text-align: center;
            margin-top: 16px;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            margin: 5px;
        }
        #startButton {
            background: #00b900;
            color: white;
        }
        #resetButton {
            background: #f44336;
            color: white;
            display: none;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #result {
            margin-top: 16px;
            padding: 16px;
            background: #E8F5E9;
            border-radius: 8px;
            display: none;
        }
        .scan-status {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .status-item {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            background: #ECEFF1;
        }
        .status-item.done {
            background: #C8E6C9;
            color: #2E7D32;
        }
        .info {
            color: #1976d2;
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .product-list {
            margin-top: 10px;
            border-top: 1px solid #ccc;
            padding-top: 10px;
        }
        .product-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            margin-bottom: 8px;
        }
        .product-header {
            font-weight: bold;
            margin-bottom: 8px;
            color: #2E7D32;
        }
        .product-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .invoice-header {
            background: #E8F5E9;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .seller-info {
            background: #F5F5F5;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .amount-info {
            background: #E3F2FD;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .total-amount {
            font-weight: bold;
            color: #1976D2;
            font-size: 1.1em;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>智慧型發票掃描器</h1>
    <div id="browserInfo" class="info">初始化中...</div>
    <div id="notice" class="notice">請掃描發票上的任一 QR Code</div>
    <div class="scan-status">
        <div id="leftStatus" class="status-item">左側 QR Code：未掃描</div>
        <div id="rightStatus" class="status-item">右側 QR Code：未掃描</div>
    </div>
    <div id="reader"></div>
    <div class="button-container">
        <button id="startButton">開始掃描</button>
        <button id="resetButton" onclick="resetScanner()">重新開始</button>
    </div>
    <div id="result"></div>
</div>

<script>
    const liffId = '2006925160-l5jA8VnP';
    let html5QrcodeScanner = null;
    let isScanning = false;
    let leftQRData = null;
    let rightQRData = null;
    let lastScannedData = null;
    let lastScannedTime = 0;
    let isLiffEnvironment = false;

    // 格式化金額
    const formatMoney = (amount) => {
        return new Intl.NumberFormat('zh-TW', {
            style: 'currency',
            currency: 'TWD',
            minimumFractionDigits: 0
        }).format(amount).replace('TWD', 'NT$');
    };

    // 格式化日期
    function formatDate(dateStr) {
        const year = parseInt(dateStr.substring(0, 3)) + 1911;
        const month = dateStr.substring(3, 5);
        const day = dateStr.substring(5, 7);
        return `${year}年${month}月${day}日`;
    }

    // 初始化應用程式
    async function initializeApp() {
        try {
            if (typeof liff !== 'undefined') {
                await liff.init({ liffId: liffId })
                    .then(() => {
                        if (liff.isInClient()) {
                            console.log('在 LINE 應用程式內執行');
                            isLiffEnvironment = true;
                            document.getElementById('browserInfo').textContent = '在 LINE 應用程式內執行中';
                            document.getElementById('startButton').disabled = false;
                        } else {
                            console.log('在外部瀏覽器執行');
                            useHTML5QRCode();
                        }
                    })
                    .catch(err => {
                        console.log('LIFF 初始化失敗:', err);
                        useHTML5QRCode();
                    });
            } else {
                console.log('LIFF SDK 未載入');
                useHTML5QRCode();
            }
        } catch (err) {
            console.error('初始化過程發生錯誤:', err);
            useHTML5QRCode();
        }
    }

    // 使用 HTML5 QR Code 掃描
    function useHTML5QRCode() {
        document.getElementById('browserInfo').textContent = '使用一般瀏覽器掃描模式';
        isLiffEnvironment = false;
    }

    // 開始掃描
    async function startScanner() {
        if (isScanning) return;

        if (isLiffEnvironment) {
            startLiffScanner();
        } else {
            startHTML5Scanner();
        }
    }

    // 使用 LIFF 掃描器
    async function startLiffScanner() {
        try {
            document.getElementById('notice').textContent = '開啟掃描中...';
            const result = await liff.scanCodeV2();
            await handleScanResult(result.value);

            if (isLiffEnvironment && ((leftQRData && !rightQRData) || (!leftQRData && rightQRData))) {
                setTimeout(() => {
                    startLiffScanner();
                }, 500);
            }
        } catch (err) {
            console.error('掃描失敗:', err);
            document.getElementById('notice').textContent = '掃描失敗：' + err.message;
            document.getElementById('browserInfo').className = 'error';
            document.getElementById('browserInfo').textContent = '發生錯誤：' + err.message;
        }
    }

    // 使用 HTML5 掃描器
    function startHTML5Scanner() {
        isScanning = true;
        document.getElementById('startButton').style.display = 'none';

        html5QrcodeScanner = new Html5Qrcode("reader");
        const config = {
            fps: 10,
            qrbox: 250
        };

        html5QrcodeScanner.start(
            { facingMode: "environment" },
            config,
            handleScanResult,
            onScanFailure
        );
    }

    // 處理掃描結果
    async function handleScanResult(decodedText) {
        try {
            const currentTime = new Date().getTime();
            if (lastScannedData === decodedText && currentTime - lastScannedTime < 1000) {
                return;
            }

            lastScannedData = decodedText;
            lastScannedTime = currentTime;

            let isNewScan = false;

            if (isLeftQRCode(decodedText) && !leftQRData) {
                leftQRData = decodedText;
                document.getElementById('leftStatus').textContent = '左側 QR Code：已掃描';
                document.getElementById('leftStatus').className = 'status-item done';
                isNewScan = true;
            } else if (isRightQRCode(decodedText) && !rightQRData) {
                rightQRData = decodedText;
                document.getElementById('rightStatus').textContent = '右側 QR Code：已掃描';
                document.getElementById('rightStatus').className = 'status-item done';
                isNewScan = true;
            }

            if (!isNewScan) {
                document.getElementById('notice').textContent = '此 QR Code 已掃描，請掃描另一側';
                return;
            }

            updateNotice();

            if (leftQRData && rightQRData) {
                await processCompleteData();
            }

            if (isLiffEnvironment && !(leftQRData && rightQRData)) {
                document.getElementById('startButton').style.display = 'none';
            } else if (!isLiffEnvironment) {
                document.getElementById('startButton').style.display = 'inline-block';
                document.getElementById('startButton').disabled = false;
            }
        } catch (error) {
            console.error('處理掃描資料時發生錯誤:', error);
        }
    }

    // 解析商品資訊
    function parseProducts(qrData) {
        try {
            const parts = qrData.split(':');
            const products = [];
            let currentProduct = {};

            for (let i = 0; i < parts.length; i++) {
                if (parts[i].includes('品名')) {
                    currentProduct = {
                        name: parts[i + 1],
                        quantity: parseInt(parts[i + 2]),
                        price: parseInt(parts[i + 3])
                    };
                    products.push(currentProduct);
                }
            }

            return products;
        } catch (error) {
            console.error('解析商品資訊時發生錯誤:', error);
            return [];
        }
    }

    // 判斷 QR Code 類型
    function isLeftQRCode(text) {
        return text.length >= 77 && !text.startsWith('**');
    }

    function isRightQRCode(text) {
        return text.startsWith('**');
    }

    // 更新提示訊息
    function updateNotice() {
        const notice = document.getElementById('notice');
        if (!leftQRData && !rightQRData) {
            notice.textContent = '請掃描左側 QR Code';
        } else if (!rightQRData) {
            notice.textContent = '請掃描右側 QR Code';
        }
    }

    function onScanFailure(error) {
        console.log(error);
    }

    // 停止掃描
    async function stopScanner() {
        if (html5QrcodeScanner) {
            try {
                await html5QrcodeScanner.stop();
                html5QrcodeScanner = null;
            } catch (error) {
                console.error('停止掃描時發生錯誤:', error);
            }
        }
        isScanning = false;
    }

    // 重設掃描器
    function resetScanner() {
        stopScanner();
        leftQRData = null;
        rightQRData = null;
        lastScannedData = null;
        lastScannedTime = 0;
        document.getElementById('notice').textContent = '請掃描發票上的任一 QR Code';
        document.getElementById('leftStatus').textContent = '左側 QR Code：未掃描';
        document.getElementById('leftStatus').className = 'status-item';
        document.getElementById('rightStatus').textContent = '右側 QR Code：未掃描';
        document.getElementById('rightStatus').className = 'status-item';
        document.getElementById('result').style.display = 'none';
        document.getElementById('result').textContent = '';
        document.getElementById('startButton').style.display = 'inline-block';
        document.getElementById('resetButton').style.display = 'none';
    }

    // 解析左側 QR Code
    function parseLeftQRCode(qrData) {
        const invoiceNumber = qrData.substring(0, 10);
        const date = qrData.substring(10, 17);
        const randomNumber = qrData.substring(17, 21);
        const salesAmount = parseInt(qrData.substring(21, 29), 16);
        const totalAmount = parseInt(qrData.substring(29, 37), 16);
        const buyerBan = qrData.substring(37, 45);
        const sellerBan = qrData.substring(45, 53);
        const encryptInfo = qrData.substring(53, 77);

        return {
            invoiceNumber,
            date,
            randomNumber,
            salesAmount,
            totalAmount,
            buyerBan,
            sellerBan,
            encryptInfo,
            taxAmount: totalAmount - salesAmount
        };
    }

    // 解析右側 QR Code
    function parseRightQRCode(qrData) {
        if (!qrData.startsWith('**')) {
            throw new Error('非右側 QR Code');
        }

        // 移除 '**' 開頭
        qrData = qrData.substring(2);

        const parts = qrData.split(':');
        let encodingType = 1; // 預設 UTF-8

        // 尋找編碼參數
        for (let i = 0; i < parts.length; i++) {
            if (parts[i].match(/^[0-3]$/)) {
                encodingType = parseInt(parts[i]);
                break;
            }
        }

        let decodedData = qrData;
        try {
            switch (encodingType) {
                case 0: // Big5
                    // 需要額外處理 Big5 編碼
                    break;
                case 1: // UTF-8
                    // UTF-8 不需特別處理
                    break;
                case 2: // Base64
                    decodedData = atob(qrData);
                    break;
                case 3: // 境外電商 UTF-8
                    // 處理境外電商特殊格式
                    break;
            }
        } catch (e) {
            console.error('解碼失敗:', e);
        }

        return parseProducts(decodedData);
    }

    // 處理完整掃描資料
    async function processCompleteData() {
        try {
            const result = document.getElementById('result');

            // 解析左側 QR Code
            const leftData = parseLeftQRCode(leftQRData);
            const products = parseRightQRCode(rightQRData);

            // 判斷是否為一般消費者
            const isConsumer = leftData.buyerBan === '00000000';

            // 準備發票資訊
            const invoiceData = {
                invoiceNumber: leftData.invoiceNumber,
                date: formatDate(leftData.date),
                randomNumber: leftData.randomNumber,
                sellerBan: leftData.sellerBan,
                buyerBan: leftData.buyerBan,
                salesAmount: leftData.salesAmount,
                taxAmount: leftData.taxAmount,
                totalAmount: leftData.totalAmount,
                products: products,
                isConsumer: isConsumer
            };

            if (isLiffEnvironment) {
                // LIFF 環境下的處理方式
                const message = generateLiffMessage(invoiceData);
                try {
                    if (liff.isInClient()) {
                        await liff.sendMessages([message]);
                        document.getElementById('notice').textContent = '發票資訊已傳送至 LINE 聊天室！';
                    }
                } catch (error) {
                    console.error('傳送訊息失敗:', error);
                    // 如果傳送失敗，fallback 到一般顯示方式
                    displayInvoiceInBrowser(invoiceData);
                }
            } else {
                // 一般瀏覽器環境下的處理方式
                displayInvoiceInBrowser(invoiceData);
            }

            result.style.display = 'block';

            stopScanner();
            document.getElementById('notice').textContent = '掃描完成！';
            document.getElementById('resetButton').style.display = 'inline-block';

        } catch (error) {
            console.error('處理資料時發生錯誤:', error);
            document.getElementById('notice').textContent = '處理資料時發生錯誤，請重新掃描';
            document.getElementById('resetButton').style.display = 'inline-block';
        }
    }

    // 生成 LIFF 訊息
    function generateLiffMessage(invoiceData) {
        // 產生 Flex Message 格式
        const message = {
            type: "flex",
            altText: `發票號碼：${invoiceData.invoiceNumber}`,
            contents: {
                type: "bubble",
                header: {
                    type: "box",
                    layout: "vertical",
                    contents: [
                        {
                            type: "text",
                            text: "電子發票資訊",
                            weight: "bold",
                            size: "xl",
                            color: "#27ae60"
                        }
                    ]
                },
                body: {
                    type: "box",
                    layout: "vertical",
                    contents: [
                        {
                            type: "box",
                            layout: "vertical",
                            margin: "lg",
                            spacing: "sm",
                            contents: [
                                {
                                    type: "box",
                                    layout: "baseline",
                                    spacing: "sm",
                                    contents: [
                                        {
                                            type: "text",
                                            text: "發票號碼",
                                            color: "#aaaaaa",
                                            size: "sm",
                                            flex: 2
                                        },
                                        {
                                            type: "text",
                                            text: invoiceData.invoiceNumber,
                                            wrap: true,
                                            size: "sm",
                                            flex: 4
                                        }
                                    ]
                                },
                                {
                                    type: "box",
                                    layout: "baseline",
                                    spacing: "sm",
                                    contents: [
                                        {
                                            type: "text",
                                            text: "開立日期",
                                            color: "#aaaaaa",
                                            size: "sm",
                                            flex: 2
                                        },
                                        {
                                            type: "text",
                                            text: invoiceData.date,
                                            wrap: true,
                                            size: "sm",
                                            flex: 4
                                        }
                                    ]
                                },
                                {
                                    type: "box",
                                    layout: "baseline",
                                    spacing: "sm",
                                    contents: [
                                        {
                                            type: "text",
                                            text: "總計金額",
                                            color: "#aaaaaa",
                                            size: "sm",
                                            flex: 2
                                        },
                                        {
                                            type: "text",
                                            text: formatMoney(invoiceData.totalAmount),
                                            wrap: true,
                                            size: "sm",
                                            flex: 4,
                                            weight: "bold",
                                            color: "#1976D2"
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                footer: {
                    type: "box",
                    layout: "vertical",
                    spacing: "sm",
                    contents: [
                        {
                            type: "button",
                            style: "link",
                            height: "sm",
                            action: {
                                type: "uri",
                                label: "查詢中獎資訊",
                                uri: "https://invoice.etax.nat.gov.tw"
                            }
                        }
                    ],
                    flex: 0
                }
            }
        };

        // 如果有商品資訊，加入商品清單
        if (invoiceData.products && invoiceData.products.length > 0) {
            const productContents = invoiceData.products.map(product => ({
                type: "box",
                layout: "horizontal",
                contents: [
                    {
                        type: "text",
                        text: product.name,
                        size: "sm",
                        flex: 3
                    },
                    {
                        type: "text",
                        text: `${product.quantity}x${formatMoney(product.price)}`,
                        size: "sm",
                        flex: 2,
                        align: "end"
                    }
                ]
            }));

            message.contents.body.contents.push({
                type: "box",
                layout: "vertical",
                margin: "lg",
                spacing: "sm",
                contents: [
                    {
                        type: "separator",
                        margin: "lg"
                    },
                    {
                        type: "text",
                        text: "商品明細",
                        weight: "bold",
                        margin: "lg"
                    },
                    ...productContents
                ]
            });
        }

        return message;
    }

    // 在瀏覽器中顯示發票資訊
    function displayInvoiceInBrowser(invoiceData) {
        const result = document.getElementById('result');

        let productsHtml = '';
        if (invoiceData.products.length > 0) {
            productsHtml = '<div class="product-list"><h4>商品明細：</h4>';
            invoiceData.products.forEach((product, index) => {
                const subtotal = product.quantity * product.price;
                productsHtml += `
                        <div class="product-item">
                            <div class="product-header">${index + 1}. ${product.name}</div>
                            <div class="product-details">
                                <div>數量：${product.quantity}</div>
                                <div>單價：${formatMoney(product.price)}</div>
                                <div>小計：${formatMoney(subtotal)}</div>
                            </div>
                        </div>
                    `;
            });
            productsHtml += '</div>';
        }

        result.innerHTML = `
                <h3>發票資訊</h3>
                <div class="invoice-header">
                    <p>發票號碼：${invoiceData.invoiceNumber}</p>
                    <p>開立日期：${invoiceData.date}</p>
                    <p>隨機碼：${invoiceData.randomNumber}</p>
                </div>
                <div class="seller-info">
                    <p>賣方統編：${invoiceData.sellerBan}</p>
                    ${!invoiceData.isConsumer ? `<p>買方統編：${invoiceData.buyerBan}</p>` : ''}
                </div>
                <div class="amount-info">
                    <p>未稅金額：${formatMoney(invoiceData.salesAmount)}</p>
                    <p>營業稅額：${formatMoney(invoiceData.taxAmount)}</p>
                    <p class="total-amount">總計金額：${formatMoney(invoiceData.totalAmount)}</p>
                </div>
                ${productsHtml}
            `;
    }

    // 綁定事件
    document.getElementById('startButton').addEventListener('click', startScanner);

    // 初始化應用程式
    initializeApp();
</script>
</body>
</html>